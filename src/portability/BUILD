cc_library(
    name = "portability",
    alwayslink = True,
    linkstatic = 1,
    copts = ["-D_GNU_SOURCE",
	     "-DWITH_POSIX",
             "-Iexternal/libcoap/include", # FIXME: for logging only
    ] + select({"//config:mingw": [],
                "//config:msvc": [],
                "//config:msys": [],
		"//config:linux": ["-std=c11", "-DHAVE_CONFIG_H", "-D_GNU_SOURCE", "-DWITH_POSIX"],
		"//config:linux64": ["-std=c11", "-DHAVE_CONFIG_H", "-D_GNU_SOURCE", "-DWITH_POSIX"],
                "//config:darwin": ["-std=c11", "-UDEBUG"],
                "//config:darwin64": ["-std=c11", "-UDEBUG"],
                "//conditions:default": ["-std=c11"]}),
    deps = ["//src/logger",
            "@libcoap//:libcoap", # FIXME: only for logging
            "@mbedtls//:mbedtls"]
    + select({"//config:android_arm7": ["//src/portability/android"],
              "//config:darwin": ["//src/portability/posix",
                                  "//src/portability/darwin"],
              "//config:darwin64": ["//src/portability/posix",
                                    "//src/portability/darwin"],
              "//config:ios_arm7": ["//src/portability/posix"],
              "//config:ios_arm64": ["//src/portability/posix"],
              "//config:ios_x86": ["//src/portability/posix"],
              "//config:linux": ["//src/portability/posix"],
              "//config:linux64": ["//src/portability/posix"],
              "//config:mingw": ["//src/portability/windows:windows"],
              "//config:msvc": ["//src/portability/windows:windows"],
              "//config:msys": ["//src/portability/posix"],
              "//config:rpi_arm8": ["//src/portability/posix"],
              #"//conditions:default": ["//src/portability/posix"]})
              "//conditions:default": ["BROKEN"]}),
    linkopts = select({"//config:msvc": ["-LIBPATH:/c/Program\ Files\ \(x86\)/Windows\ Kits/10/lib/10.0.15063.0/um/x64 bcrypt.lib"],
                       "//config:msys": ["-L/c/Program\ Files\ \(x86\)/Windows\ Kits/10/lib/10.0.15063.0/um/x64", "-lbcrypt"],
                       "//config:mingw": ["-L/c/Program\ Files\ \(x86\)/Windows\ Kits/10/lib/10.0.15063.0/um/x64", "-lbcrypt"],
                       "//conditions:default": []}),
    hdrs = glob(["*.h"]),
    srcs = glob(["*.c"]) + glob(["*.h"]),
    visibility = ["//visibility:public"]
    # visibility = ["//src:__subpackages__",
    #               "//third_party:__subpackages__",
    #               "//tools/cbor:__subpackages__",
    # ]
 )
