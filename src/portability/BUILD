# TODO: tizen support
cc_library(
    name = "portability",
    # alwayslink = True,
    linkstatic = 1,
    copts = ["-Iexternal//mbedtls/include",
             # Some source files #include "mbedtls/config.h", others just "config.h"
             "-Iconfig",
             "-Iconfig/mbedtls",
             "-Iexternal/mbedtls/patched/include",

	     "-D_GNU_SOURCE",
	     "-DWITH_POSIX",
    ] + select({"//config:windows": [],
                "//config:msvc": [],
                "//config:msys": [],
		"//config:linux": ["-std=c11", "-DHAVE_CONFIG_H", "-D_GNU_SOURCE", "-DWITH_POSIX"],
		"//config:linux-x86_64": ["-std=c11", "-DHAVE_CONFIG_H", "-D_GNU_SOURCE", "-DWITH_POSIX"],
                "//config:darwin": ["-std=c11", "-UDEBUG"],
                "//config:darwin64": ["-std=c11", "-UDEBUG"],
                "//conditions:default": ["-std=c11"]}),
    deps = ["//src/logger",
            # "//third_party/mbedtls",
            # "//third_party/mbedtls:mbedtls-crypto",
            # "//third_party/mbedtls:mbedtls-x509",
            "@mbedtls//:mbedtls"
    ] + select({"//config:linux": ["//src/portability/posix"],
                "//config:linux-x86_64": ["//src/portability/posix"],
                "//config:rpi_arm8": ["//src/portability/posix"],
			          # "//src/portability/linux"],
                "//config:windows": ["//src/portability/windows:win"],
                "//config:msvc": ["//src/portability/windows:win"],
                "//config:msys": ["//src/portability/posix"],
                "//config:darwin": ["//src/portability/posix",
                            "//src/portability/darwin"],
                "//config:darwin64": ["//src/portability/posix",
                              "//src/portability/darwin"],
                "//config:android": ["//src/portability/android"],
              "//conditions:default": ["BROKEN"]}),
    # hdrs = glob(["*.h"]),
    linkopts = select({"//config:msvc": ["-LIBPATH:/c/Program\ Files\ \(x86\)/Windows\ Kits/10/lib/10.0.15063.0/um/x64 bcrypt.lib"],
                       "//config:msys": ["-L/c/Program\ Files\ \(x86\)/Windows\ Kits/10/lib/10.0.15063.0/um/x64", "-lbcrypt"],
                       "//config:windows": ["-LIBPATH:/c/Program\ Files\ \(x86\)/Windows\ Kits/10/lib/10.0.15063.0/um/x64 bcrypt.lib"],
                       "//conditions:default": []}),
    srcs = glob(["*.c"]) + glob(["*.h"]),
    visibility = ["//visibility:public"]
    # visibility = ["//src:__subpackages__",
    #               "//third_party:__subpackages__",
    #               "//tools/cbor:__subpackages__",
    # ]
 )
